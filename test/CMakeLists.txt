cmake_minimum_required(VERSION 3.17)
project(ffmpeg_test)
set(FEATURES "avcodec;avformat;bzip2;opus;postproc;snappy;soxr;swresample;vpx;x265;zlib" CACHE STRING "List of all features enabled through vcpkg.")
enable_testing()
add_subdirectory(avutil)
if ("avcodec" IN_LIST FEATURES)
  add_subdirectory(avcodec)
  add_test(NAME test_encoder_aac COMMAND test_find_encoder aac)
  add_test(NAME test_decoder_aac COMMAND test_find_decoder aac)
  add_test(NAME test_encoder_flac COMMAND test_find_encoder flac)
  add_test(NAME test_decoder_flac COMMAND test_find_decoder flac)
  add_test(NAME test_encoder_ffv1 COMMAND test_find_encoder ffv1)
  add_test(NAME test_decoder_ffv1 COMMAND test_find_decoder ffv1)
  if ("snappy" IN_LIST FEATURES)
    add_test(NAME test_encoder_hap COMMAND test_find_encoder hap)
  endif()
  add_test(NAME test_decoder_hap COMMAND test_find_decoder hap)
  add_test(NAME test_encoder_mpeg4 COMMAND test_find_encoder mpeg4)
  add_test(NAME test_decoder_mpeg4 COMMAND test_find_decoder mpeg4)
  add_test(NAME test_encoder_opus COMMAND test_find_encoder opus)
  if ("swresample" IN_LIST FEATURES)  # built-in opus decoder depends on swresample
    add_test(NAME test_decoder_opus COMMAND test_find_decoder opus)
  endif()
  if ("opus" IN_LIST FEATURES)
    add_test(NAME test_encoder_libopus COMMAND test_find_encoder libopus)
    add_test(NAME test_decoder_libopus COMMAND test_find_decoder libopus)
  endif()
  add_test(NAME test_decoder_vp8 COMMAND test_find_decoder vp8)
  add_test(NAME test_decoder_vp9 COMMAND test_find_decoder vp9)
  if ("vpx" IN_LIST FEATURES)
    add_test(NAME test_encoder_libvpx_vp8 COMMAND test_find_encoder libvpx)
    add_test(NAME test_decoder_libvpx_vp8 COMMAND test_find_decoder libvpx)
    add_test(NAME test_encoder_libvpx_vp9 COMMAND test_find_encoder libvpx-vp9)
    add_test(NAME test_decoder_libvpx_vp9 COMMAND test_find_decoder libvpx-vp9)
  endif()
  if ("x265" IN_LIST FEATURES)
    add_test(NAME test_encoder_libx265 COMMAND test_find_encoder libx265)
  endif()
endif()
if ("avformat" IN_LIST FEATURES)
  add_subdirectory(avformat)
  if ("bzip2" IN_LIST FEATURES)
    add_test(NAME test_bzip2 COMMAND test_read_frame "${CMAKE_CURRENT_SOURCE_DIR}/prores_bz2.mkv")
  endif()
  if ("zlib" IN_LIST FEATURES)
    add_test(NAME test_zlib COMMAND test_read_frame "${CMAKE_CURRENT_SOURCE_DIR}/prores_zlib.mkv")
  endif()
endif()
if ("postproc" IN_LIST FEATURES)
  add_subdirectory(postproc)
endif()
if ("swresample" IN_LIST FEATURES)
  add_subdirectory(swresample)
  add_test(NAME test_swresample_swr COMMAND test_swresample swr)
  if ("soxr" IN_LIST FEATURES)
    add_test(NAME test_swresample_soxr COMMAND test_swresample soxr)
  endif()
endif()
